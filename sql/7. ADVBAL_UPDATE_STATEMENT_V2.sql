/*
CREATE TABLE RBL_PRODUCTION.ADVBAL_ACTUAL_AC
AS
   SELECT *
     FROM ADVBAL
    WHERE     ADVBAL_ENTITY_NUM = 1
          AND ADVBAL_INTERNAL_ACNUM IN
                 (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE);
                 
                 
CREATE TABLE RBL_PRODUCTION.ADVBBAL_ACTUAL_AC
AS
   SELECT *
     FROM ADVBBAL
    WHERE     ADVBBAL_ENTITY_NUM = 1
          AND ADVBBAL_INTERNAL_ACNUM IN
                 (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE);
                 
                 
CREATE TABLE RBL_PRODUCTION.ADVVDBBAL_ACTUAL_AC
AS
   SELECT *
     FROM ADVVDBBAL
    WHERE     ADVVDBBAL_ENTITY_NUM = 1
          AND ADVVDBBAL_INTERNAL_ACNUM IN
                 (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE);
                 
                 
CREATE TABLE RBL_PRODUCTION.ACNTVDBBAL_ACTUAL_AC
AS
   SELECT *
     FROM ACNTVDBBAL
    WHERE     ACNTVBBAL_ENTITY_NUM = 1
          AND ACNTVBBAL_INTERNAL_ACNUM IN
                 (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE);


--ADVBAL

DECLARE
   V_COUNT    NUMBER := 0;
   V_AC_NUM   NUMBER;
BEGIN
   FOR IDX
      IN (  SELECT * FROM ACTUAL_ACCOUNT_UPDATE)
   LOOP
   BEGIN
      IF IDX.SL = 1
      THEN
         V_AC_NUM := IDX.IACLINK_INTERNAL_ACNUM;
      END IF;

      UPDATE ADVBAL
         SET ADVBAL_INTERNAL_ACNUM = V_AC_NUM
       WHERE     ADVBAL_ENTITY_NUM = 1
             AND ADVBAL_INTERNAL_ACNUM = IDX.IACLINK_INTERNAL_ACNUM;
             
   EXCEPTION WHEN DUP_VAL_ON_INDEX THEN 
   CONTINUE ;
   END ;
   END LOOP;
END;


-- ADVBBAL

DECLARE
   V_COUNT    NUMBER := 0;
   V_AC_NUM   NUMBER;
BEGIN
   FOR IDX
      IN (  SELECT * FROM ACTUAL_ACCOUNT_UPDATE)
   LOOP
   BEGIN
      IF IDX.SL = 1
      THEN
         V_AC_NUM := IDX.IACLINK_INTERNAL_ACNUM;
      END IF;

      UPDATE ADVBBAL
         SET ADVBBAL_INTERNAL_ACNUM = V_AC_NUM
       WHERE     ADVBBAL_ENTITY_NUM = 1
             AND ADVBBAL_INTERNAL_ACNUM = IDX.IACLINK_INTERNAL_ACNUM;
             
   EXCEPTION WHEN DUP_VAL_ON_INDEX THEN 
   CONTINUE ;
   END ;
   END LOOP;
END;



-- ADVVDBBAL

DECLARE
   V_COUNT    NUMBER := 0;
   V_AC_NUM   NUMBER;
BEGIN
   FOR IDX
      IN (  SELECT * FROM ACTUAL_ACCOUNT_UPDATE)
   LOOP
   BEGIN
      IF IDX.SL = 1
      THEN
         V_AC_NUM := IDX.IACLINK_INTERNAL_ACNUM;
      END IF;

      UPDATE ADVVDBBAL
         SET ADVVDBBAL_INTERNAL_ACNUM = V_AC_NUM
       WHERE     ADVVDBBAL_ENTITY_NUM = 1
             AND ADVVDBBAL_INTERNAL_ACNUM = IDX.IACLINK_INTERNAL_ACNUM;
             
   EXCEPTION WHEN DUP_VAL_ON_INDEX THEN 
   CONTINUE ;
   END ;
   END LOOP;
END;



-- ACNTVDBBAL

DECLARE
   V_COUNT    NUMBER := 0;
   V_AC_NUM   NUMBER;
BEGIN
   FOR IDX
      IN (  SELECT * FROM ACTUAL_ACCOUNT_UPDATE)
   LOOP
   BEGIN
      IF IDX.SL = 1
      THEN
         V_AC_NUM := IDX.IACLINK_INTERNAL_ACNUM;
      END IF;

      UPDATE ACNTVDBBAL
         SET ACNTVBBAL_INTERNAL_ACNUM = V_AC_NUM
       WHERE     ACNTVBBAL_ENTITY_NUM = 1
             AND ACNTVBBAL_INTERNAL_ACNUM = IDX.IACLINK_INTERNAL_ACNUM;
             
   EXCEPTION WHEN DUP_VAL_ON_INDEX THEN 
   CONTINUE ;
   END ;
   END LOOP;
END;



*/


--------- UPDATE ADVBAL --------------


BEGIN
FOR IND IN (
WITH TRAN_ADBBAL_TABLE  AS
(SELECT LNACNT_INTERNAL_ACNUM, TRANADV_PRIN_AC_AMT_DR ADVBAL_PRIN_AC_DB_SUM, TRANADV_PRIN_AC_AMT_CR ADVBAL_PRIN_AC_CR_SUM, 
(TRANADV_PRIN_AC_AMT_CR-TRANADV_PRIN_AC_AMT_DR) ADVBAL_PRIN_AC_BAL,
TRANADV_INTRD_AC_AMT_DR ADVBAL_INTRD_AC_DB_SUM, TRANADV_INTRD_AC_AMT_CR ADVBAL_INTRD_AC_CR_SUM, (TRANADV_INTRD_AC_AMT_CR-TRANADV_INTRD_AC_AMT_DR) ADVBAL_INTRD_AC_BAL,
TRANADV_CHARGE_AC_AMT_DR ADVBAL_CHARGE_AC_DB_SUM, TRANADV_CHARGE_AC_AMT_CR ADVBAL_CHARGE_AC_CR_SUM, (TRANADV_CHARGE_AC_AMT_CR-TRANADV_CHARGE_AC_AMT_DR) ADVBAL_CHARGE_AC_BAL,
((TRANADV_PRIN_AC_AMT_CR-TRANADV_PRIN_AC_AMT_DR) + (TRANADV_INTRD_AC_AMT_CR-TRANADV_INTRD_AC_AMT_DR)+(TRANADV_CHARGE_AC_AMT_CR-TRANADV_CHARGE_AC_AMT_DR) ) ACCOUNT_CURR_BAL
FROM(
SELECT LNACNT_INTERNAL_ACNUM, 
SUM(TRANADV_PRIN_AC_AMT_DR)  TRANADV_PRIN_AC_AMT_DR,
SUM(TRANADV_PRIN_AC_AMT_CR) TRANADV_PRIN_AC_AMT_CR, 
SUM(TRANADV_INTRD_AC_AMT_DR) TRANADV_INTRD_AC_AMT_DR, 
SUM(TRANADV_INTRD_AC_AMT_CR) TRANADV_INTRD_AC_AMT_CR, 
SUM(TRANADV_CHARGE_AC_AMT_DR) TRANADV_CHARGE_AC_AMT_DR, 
SUM(TRANADV_CHARGE_AC_AMT_CR) TRANADV_CHARGE_AC_AMT_CR
 FROM (
(SELECT  L.LNACNT_INTERNAL_ACNUM,TRAN_DATE_OF_TRAN, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2014 T, LOANACNTS L,ACNTS A,  TRANADV2014 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10101600001312
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 )
UNION ALL
(SELECT  L.LNACNT_INTERNAL_ACNUM,TRAN_DATE_OF_TRAN, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2015 T, LOANACNTS L,ACNTS A,  TRANADV2015 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10101600001312
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 )
UNION ALL
(SELECT  L.LNACNT_INTERNAL_ACNUM,TRAN_DATE_OF_TRAN, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2016 T, LOANACNTS L,ACNTS A,  TRANADV2016 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10101600001312
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 )
UNION ALL
(SELECT  L.LNACNT_INTERNAL_ACNUM,TRAN_DATE_OF_TRAN, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2017 T, LOANACNTS L,ACNTS A,  TRANADV2017 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10101600001312
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 )
UNION ALL
(SELECT  L.LNACNT_INTERNAL_ACNUM,TRAN_DATE_OF_TRAN, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2018 T, LOANACNTS L,ACNTS A,  TRANADV2018 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10101600001312
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 )
UNION ALL
(SELECT  L.LNACNT_INTERNAL_ACNUM,TRAN_DATE_OF_TRAN, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2019 T, LOANACNTS L,ACNTS A,  TRANADV2019 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10101600001312
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 )
UNION ALL
(SELECT  L.LNACNT_INTERNAL_ACNUM,TRAN_DATE_OF_TRAN, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2020 T, LOANACNTS L,ACNTS A,  TRANADV2020 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10101600001312
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 )
UNION ALL
(SELECT  L.LNACNT_INTERNAL_ACNUM,TRAN_DATE_OF_TRAN, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2021 T, LOANACNTS L,ACNTS A,  TRANADV2021 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10101600001312
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 )
UNION ALL
(SELECT  L.LNACNT_INTERNAL_ACNUM,TRAN_DATE_OF_TRAN, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2022 T, LOANACNTS L,ACNTS A,  TRANADV2022 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10101600001312
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 )
UNION ALL
(SELECT  L.LNACNT_INTERNAL_ACNUM,TRAN_DATE_OF_TRAN, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2023 T, LOANACNTS L,ACNTS A,  TRANADV2023 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10101600001312
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 ))
GROUP BY LNACNT_INTERNAL_ACNUM)
ORDER BY 1)
SELECT AD.ADVBAL_INTERNAL_ACNUM,  T.ADVBAL_PRIN_AC_BAL, AD.ADVBAL_PRIN_AC_BAL VADVBAL_PRIN_AC_BAL, T.ADVBAL_INTRD_AC_BAL, AD.ADVBAL_INTRD_AC_BAL VADVBAL_INTRD_AC_BAL,T.ADVBAL_CHARGE_AC_BAL,  AD.ADVBAL_CHARGE_AC_BAL VADVBAL_CHARGE_AC_BAL, 
T.ADVBAL_PRIN_AC_DB_SUM, AD.ADVBAL_PRIN_AC_DB_SUM VADVBAL_PRIN_AC_DB_SUM,T.ADVBAL_PRIN_AC_CR_SUM, AD.ADVBAL_PRIN_AC_CR_SUM VADVBAL_PRIN_AC_CR_SUM, 
T.ADVBAL_INTRD_AC_DB_SUM, AD.ADVBAL_INTRD_AC_DB_SUM VADVBAL_INTRD_AC_DB_SUM, T.ADVBAL_INTRD_AC_CR_SUM, AD.ADVBAL_INTRD_AC_CR_SUM VADVBAL_INTRD_AC_CR_SUM,
T.ADVBAL_CHARGE_AC_DB_SUM, AD.ADVBAL_CHARGE_AC_DB_SUM VADVBAL_CHARGE_AC_DB_SUM, T.ADVBAL_CHARGE_AC_CR_SUM, AD.ADVBAL_CHARGE_AC_CR_SUM VADVBAL_CHARGE_AC_CR_SUM 
FROM TRAN_ADBBAL_TABLE T, ADVBAL AD
WHERE AD.ADVBAL_INTERNAL_ACNUM=T.LNACNT_INTERNAL_ACNUM
AND  (T.ADVBAL_PRIN_AC_BAL<>AD.ADVBAL_PRIN_AC_BAL
        OR T.ADVBAL_INTRD_AC_BAL<>AD.ADVBAL_INTRD_AC_BAL 
        OR T.ADVBAL_CHARGE_AC_BAL<>AD.ADVBAL_CHARGE_AC_BAL 
        OR T.ADVBAL_PRIN_AC_DB_SUM<>AD.ADVBAL_PRIN_AC_DB_SUM
        OR T.ADVBAL_PRIN_AC_CR_SUM<>AD.ADVBAL_PRIN_AC_CR_SUM
        OR T.ADVBAL_INTRD_AC_DB_SUM<>AD.ADVBAL_INTRD_AC_DB_SUM
        OR T.ADVBAL_INTRD_AC_CR_SUM<>AD.ADVBAL_INTRD_AC_CR_SUM
        OR T.ADVBAL_CHARGE_AC_DB_SUM<>AD.ADVBAL_CHARGE_AC_DB_SUM
        OR T.ADVBAL_CHARGE_AC_CR_SUM<>AD.ADVBAL_CHARGE_AC_CR_SUM
        ))
        LOOP
UPDATE ADVBAL
SET ADVBAL_PRIN_AC_BAL=IND.ADVBAL_PRIN_AC_BAL,ADVBAL_PRIN_BC_BAL=IND.ADVBAL_PRIN_AC_BAL,
       ADVBAL_INTRD_AC_BAL=IND.ADVBAL_INTRD_AC_BAL,ADVBAL_INTRD_BC_BAL=IND.ADVBAL_INTRD_AC_BAL,
       ADVBAL_CHARGE_AC_BAL=IND.ADVBAL_CHARGE_AC_BAL,ADVBAL_CHARGE_BC_BAL=IND.ADVBAL_CHARGE_AC_BAL,
       ADVBAL_PRIN_AC_DB_SUM=IND.ADVBAL_PRIN_AC_DB_SUM,ADVBAL_PRIN_BC_DB_SUM=IND.ADVBAL_PRIN_AC_DB_SUM,
       ADVBAL_PRIN_AC_CR_SUM=IND.ADVBAL_PRIN_AC_CR_SUM,ADVBAL_PRIN_BC_CR_SUM=IND.ADVBAL_PRIN_AC_CR_SUM,
       ADVBAL_INTRD_AC_DB_SUM=IND.ADVBAL_INTRD_AC_DB_SUM,ADVBAL_INTRD_BC_DB_SUM=IND.ADVBAL_INTRD_AC_DB_SUM,
       ADVBAL_INTRD_AC_CR_SUM=IND.ADVBAL_INTRD_AC_CR_SUM,ADVBAL_INTRD_BC_CR_SUM=IND.ADVBAL_INTRD_AC_CR_SUM,
       ADVBAL_CHARGE_AC_DB_SUM=IND.ADVBAL_CHARGE_AC_DB_SUM,ADVBAL_CHARGE_BC_DB_SUM=IND.ADVBAL_CHARGE_AC_DB_SUM,
       ADVBAL_CHARGE_AC_CR_SUM=IND.ADVBAL_CHARGE_AC_CR_SUM, ADVBAL_CHARGE_BC_CR_SUM=IND.ADVBAL_CHARGE_AC_CR_SUM
WHERE ADVBAL_INTERNAL_ACNUM=IND.ADVBAL_INTERNAL_ACNUM;

END LOOP;
END ;
       

------------------------ UPDATE ADVBBAL -----------------------


BEGIN
FOR IND IN (
WITH  TRAN_LOAN_ADVBAL AS(
SELECT NVL(LNACNT_INTERNAL_ACNUM,RECORDS.ADVBBAL_INTERNAL_ACNUM) ADVBBAL_INTERNAL_ACNUM,  NVL(TRAN_YEAR,RECORDS.ADVBBAL_YEAR) ADVBBAL_YEAR,  NVL(TRAN_MONTH,RECORDS.ADVBBAL_MONTH) ADVBBAL_MONTH,  
TRANADV_PRIN_AC_AMT_OS, ADVBBAL_PRIN_AC_OPBAL, ADVBBAL_INTRD_AC_OPBAL, ADVBBAL_CHARGE_AC_OPBAL, ADVBBAL_PRIN_AC_DB_OPBAL, ADVBBAL_PRIN_AC_CR_OPBAL, 
ADVBBAL_INTRD_AC_DB_OPBAL, ADVBBAL_INTRD_AC_CR_OPBAL, ADVBBAL_CHARGE_AC_DB_OPBAL, ADVBBAL_CHARGE_AC_CR_OPBAL
FROM (SELECT LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH,  TRANADV_PRIN_AC_AMT_OS, 
SUM(ADVBBAL_PRIN_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_DB_OPBAL,
SUM(ADVBBAL_PRIN_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_CR_OPBAL,
SUM(ADVBBAL_PRIN_AC_CR_OPBAL-ADVBBAL_PRIN_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_OPBAL,
SUM(ADVBBAL_INTRD_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_DB_OPBAL,
SUM(ADVBBAL_INTRD_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_CR_OPBAL,
SUM(ADVBBAL_INTRD_AC_CR_OPBAL-ADVBBAL_INTRD_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_OPBAL,
SUM(ADVBBAL_CHARGE_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_DB_OPBAL,
SUM(ADVBBAL_CHARGE_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_CR_OPBAL,
SUM(ADVBBAL_CHARGE_AC_CR_OPBAL-ADVBBAL_CHARGE_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_OPBAL
FROM(
SELECT LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH, SUM(TRANADV_PRIN_AC_AMT_DR) ADVBBAL_PRIN_AC_DB_OPBAL, SUM(TRANADV_PRIN_AC_AMT_CR) ADVBBAL_PRIN_AC_CR_OPBAL, 
(SUM(TRANADV_PRIN_AC_AMT_CR) -SUM(TRANADV_PRIN_AC_AMT_DR)) TRANADV_PRIN_AC_AMT_OS,
SUM(TRANADV_INTRD_AC_AMT_DR) ADVBBAL_INTRD_AC_DB_OPBAL,SUM(TRANADV_INTRD_AC_AMT_CR) ADVBBAL_INTRD_AC_CR_OPBAL,
(SUM(TRANADV_INTRD_AC_AMT_CR)-SUM(TRANADV_INTRD_AC_AMT_DR)) TRANADV_INTRD_AC_AMT_OS,  
SUM(TRANADV_CHARGE_AC_AMT_DR) ADVBBAL_CHARGE_AC_DB_OPBAL, SUM(TRANADV_CHARGE_AC_AMT_CR) ADVBBAL_CHARGE_AC_CR_OPBAL,
(SUM(TRANADV_CHARGE_AC_AMT_CR) -SUM(TRANADV_CHARGE_AC_AMT_DR)) TRANADV_CHARGE_AC_AMT_OS
FROM(
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2014 T, LOANACNTS L,ACNTS A,  TRANADV2014 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2015 T, LOANACNTS L,ACNTS A,  TRANADV2015 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2016 T, LOANACNTS L,ACNTS A,  TRANADV2016 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2017 T, LOANACNTS L,ACNTS A,  TRANADV2017 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2018 T, LOANACNTS L,ACNTS A,  TRANADV2018 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2019 T, LOANACNTS L,ACNTS A,  TRANADV2019 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2020 T, LOANACNTS L,ACNTS A,  TRANADV2020 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2021 T, LOANACNTS L,ACNTS A,  TRANADV2021 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2022 T, LOANACNTS L,ACNTS A,  TRANADV2022 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0)
GROUP BY LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH 
ORDER BY 1,2,3)) TRAN FULL OUTER JOIN (SELECT DISTINCT ADVBBAL_INTERNAL_ACNUM, ADVBBAL_YEAR, ADVBBAL_MONTH
FROM ADVBBAL AD, ACNTS A
WHERE AD.ADVBBAL_INTERNAL_ACNUM=A.ACNTS_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
--AND  ADVBBAL_INTERNAL_ACNUM =10104000001722
AND ADVBBAL_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
ORDER BY ADVBBAL_YEAR, ADVBBAL_MONTH) RECORDS
ON (TRAN.LNACNT_INTERNAL_ACNUM=RECORDS.ADVBBAL_INTERNAL_ACNUM AND TRAN.TRAN_YEAR=RECORDS.ADVBBAL_YEAR AND TRAN.TRAN_MONTH=RECORDS.ADVBBAL_MONTH))
SELECT TADV.ADVBBAL_INTERNAL_ACNUM, TADV.ADVBBAL_YEAR,TADV.ADVBBAL_MONTH, ADV.IACLINK_ACTUAL_ACNUM, ADV.IACLINK_BRN_CODE,  
(CASE WHEN (TADV.ADVBBAL_PRIN_AC_OPBAL<>ADV.ADVBBAL_PRIN_AC_OPBAL) THEN 'PO' 
         WHEN  (TADV.ADVBBAL_INTRD_AC_OPBAL<>ADV.ADVBBAL_INTRD_AC_OPBAL) THEN 'IO'
         WHEN (TADV.ADVBBAL_CHARGE_AC_OPBAL<>ADV.ADVBBAL_CHARGE_AC_OPBAL) THEN 'CO'
         WHEN (TADV.ADVBBAL_PRIN_AC_DB_OPBAL<>ADV.ADVBBAL_PRIN_AC_DB_OPBAL) THEN 'PD'
         WHEN (TADV.ADVBBAL_PRIN_AC_CR_OPBAL<>ADV.ADVBBAL_PRIN_AC_CR_OPBAL) THEN 'PC'
         WHEN (TADV.ADVBBAL_INTRD_AC_DB_OPBAL<>ADV.ADVBBAL_INTRD_AC_DB_OPBAL) THEN 'ID'
         WHEN (TADV.ADVBBAL_INTRD_AC_CR_OPBAL<>ADV.ADVBBAL_INTRD_AC_CR_OPBAL) THEN 'IC'
         WHEN (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL<>ADV.ADVBBAL_CHARGE_AC_DB_OPBAL) THEN 'CD'
         WHEN (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL<>ADV.ADVBBAL_CHARGE_AC_CR_OPBAL) THEN 'CC'
         ELSE 'NA' END ) DIFFERENCE, TADV.ADVBBAL_PRIN_AC_OPBAL,ADV.ADVBBAL_PRIN_AC_OPBAL VADVBBAL_PRIN_AC_OPBAL,
         TADV.ADVBBAL_INTRD_AC_OPBAL,ADV.ADVBBAL_INTRD_AC_OPBAL VADVBBAL_INTRD_AC_OPBAL, TADV.ADVBBAL_CHARGE_AC_OPBAL, 
         ADV.ADVBBAL_CHARGE_AC_OPBAL VADVBBAL_CHARGE_AC_OPBAL,TADV.ADVBBAL_PRIN_AC_DB_OPBAL,ADV.ADVBBAL_PRIN_AC_DB_OPBAL VADVBBAL_PRIN_AC_DB_OPBAL,  
         TADV.ADVBBAL_PRIN_AC_CR_OPBAL, ADV.ADVBBAL_PRIN_AC_CR_OPBAL VADVBBAL_PRIN_AC_CR_OPBAL, TADV.ADVBBAL_INTRD_AC_DB_OPBAL,
         ADV.ADVBBAL_INTRD_AC_DB_OPBAL VADVBBAL_INTRD_AC_DB_OPBAL, TADV.ADVBBAL_INTRD_AC_CR_OPBAL,  ADV.ADVBBAL_INTRD_AC_CR_OPBAL  VADVBBAL_INTRD_AC_CR_OPBAL,
         TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,ADV.ADVBBAL_CHARGE_AC_DB_OPBAL VADVBBAL_CHARGE_AC_DB_OPBAL,TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,
          ADV.ADVBBAL_CHARGE_AC_CR_OPBAL VADVBBAL_CHARGE_AC_CR_OPBAL
FROM(
SELECT TADV.ADVBBAL_INTERNAL_ACNUM, TADV.ADVBBAL_YEAR,TADV.ADVBBAL_MONTH, 
NVL(TADV.ADVBBAL_PRIN_AC_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_OPBAL, 
NVL(TADV.ADVBBAL_PRIN_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_PRIN_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_CR_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_CR_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_CR_OPBAL
 FROM TRAN_LOAN_ADVBAL TADV) TADV, (SELECT ADVBBAL_INTERNAL_ACNUM, IA.IACLINK_ACTUAL_ACNUM, IA.IACLINK_BRN_CODE, ADVBBAL_YEAR, ADVBBAL_MONTH, ADVBBAL_PRIN_AC_OPBAL, 
 ADVBBAL_INTRD_AC_OPBAL, ADVBBAL_CHARGE_AC_OPBAL, ADVBBAL_PRIN_AC_DB_OPBAL, ADVBBAL_PRIN_AC_CR_OPBAL, ADVBBAL_INTRD_AC_DB_OPBAL, 
 ADVBBAL_INTRD_AC_CR_OPBAL, ADVBBAL_CHARGE_AC_DB_OPBAL, ADVBBAL_CHARGE_AC_CR_OPBAL
FROM ADVBBAL AD, ACNTS A, IACLINK IA
WHERE AD.ADVBBAL_INTERNAL_ACNUM=A.ACNTS_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=IA.IACLINK_INTERNAL_ACNUM
AND AD.ADVBBAL_INTERNAL_ACNUM=IA.IACLINK_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
) ADV 
WHERE TADV.ADVBBAL_INTERNAL_ACNUM=ADV.ADVBBAL_INTERNAL_ACNUM
AND TADV.ADVBBAL_YEAR=ADV.ADVBBAL_YEAR
AND TADV.ADVBBAL_MONTH=ADV.ADVBBAL_MONTH
AND ((TADV.ADVBBAL_PRIN_AC_OPBAL<>ADV.ADVBBAL_PRIN_AC_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_OPBAL<>ADV.ADVBBAL_INTRD_AC_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_OPBAL<>ADV.ADVBBAL_CHARGE_AC_OPBAL)
         OR (TADV.ADVBBAL_PRIN_AC_DB_OPBAL<>ADV.ADVBBAL_PRIN_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_PRIN_AC_CR_OPBAL<>ADV.ADVBBAL_PRIN_AC_CR_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_DB_OPBAL<>ADV.ADVBBAL_INTRD_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_CR_OPBAL<>ADV.ADVBBAL_INTRD_AC_CR_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL<>ADV.ADVBBAL_CHARGE_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL<>ADV.ADVBBAL_CHARGE_AC_CR_OPBAL))
ORDER BY 1,2,3)
LOOP
UPDATE ADVBBAL
SET ADVBBAL_PRIN_AC_OPBAL=IND.ADVBBAL_PRIN_AC_OPBAL, ADVBBAL_PRIN_BC_OPBAL=IND.ADVBBAL_PRIN_AC_OPBAL,
        ADVBBAL_INTRD_AC_OPBAL=IND.ADVBBAL_INTRD_AC_OPBAL, ADVBBAL_INTRD_BC_OPBAL=IND.ADVBBAL_INTRD_AC_OPBAL,
        ADVBBAL_CHARGE_AC_OPBAL=IND.ADVBBAL_CHARGE_AC_OPBAL, ADVBBAL_CHARGE_BC_OPBAL=IND.ADVBBAL_CHARGE_AC_OPBAL,
        ADVBBAL_PRIN_AC_DB_OPBAL=IND.ADVBBAL_PRIN_AC_DB_OPBAL, ADVBBAL_PRIN_BC_DB_OPBAL=IND.ADVBBAL_PRIN_AC_DB_OPBAL,
        ADVBBAL_PRIN_AC_CR_OPBAL=IND.ADVBBAL_PRIN_AC_CR_OPBAL,ADVBBAL_PRIN_BC_CR_OPBAL=IND.ADVBBAL_PRIN_AC_CR_OPBAL,
        ADVBBAL_INTRD_AC_DB_OPBAL=IND.ADVBBAL_INTRD_AC_DB_OPBAL, ADVBBAL_INTRD_BC_DB_OPBAL=IND.ADVBBAL_INTRD_AC_DB_OPBAL,
        ADVBBAL_INTRD_AC_CR_OPBAL=IND.ADVBBAL_INTRD_AC_CR_OPBAL, ADVBBAL_INTRD_BC_CR_OPBAL=IND.ADVBBAL_INTRD_AC_CR_OPBAL,
        ADVBBAL_CHARGE_AC_DB_OPBAL=IND.ADVBBAL_CHARGE_AC_DB_OPBAL, ADVBBAL_CHARGE_BC_DB_OPBAL=IND.ADVBBAL_CHARGE_AC_DB_OPBAL,
        ADVBBAL_CHARGE_AC_CR_OPBAL=IND.ADVBBAL_CHARGE_AC_CR_OPBAL, ADVBBAL_CHARGE_BC_CR_OPBAL=IND.ADVBBAL_CHARGE_AC_CR_OPBAL
WHERE ADVBBAL_INTERNAL_ACNUM=IND.ADVBBAL_INTERNAL_ACNUM
AND ADVBBAL_YEAR=IND.ADVBBAL_YEAR
AND ADVBBAL_MONTH=IND.ADVBBAL_MONTH;

END LOOP;
END;


----- update ADVBBAL---------


BEGIN
FOR IND IN (
WITH  TRAN_LOAN_ADVBAL AS(
SELECT NVL(LNACNT_INTERNAL_ACNUM,RECORDS.ADVBBAL_INTERNAL_ACNUM) ADVBBAL_INTERNAL_ACNUM,  NVL(TRAN_YEAR,RECORDS.ADVBBAL_YEAR) ADVBBAL_YEAR,  NVL(TRAN_MONTH,RECORDS.ADVBBAL_MONTH) ADVBBAL_MONTH,  
TRANADV_PRIN_AC_AMT_OS, ADVBBAL_PRIN_AC_OPBAL, ADVBBAL_INTRD_AC_OPBAL, ADVBBAL_CHARGE_AC_OPBAL, ADVBBAL_PRIN_AC_DB_OPBAL, ADVBBAL_PRIN_AC_CR_OPBAL, 
ADVBBAL_INTRD_AC_DB_OPBAL, ADVBBAL_INTRD_AC_CR_OPBAL, ADVBBAL_CHARGE_AC_DB_OPBAL, ADVBBAL_CHARGE_AC_CR_OPBAL
FROM (SELECT LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH,  TRANADV_PRIN_AC_AMT_OS, 
SUM(ADVBBAL_PRIN_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_DB_OPBAL,
SUM(ADVBBAL_PRIN_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_CR_OPBAL,
SUM(ADVBBAL_PRIN_AC_CR_OPBAL-ADVBBAL_PRIN_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_OPBAL,
SUM(ADVBBAL_INTRD_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_DB_OPBAL,
SUM(ADVBBAL_INTRD_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_CR_OPBAL,
SUM(ADVBBAL_INTRD_AC_CR_OPBAL-ADVBBAL_INTRD_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_OPBAL,
SUM(ADVBBAL_CHARGE_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_DB_OPBAL,
SUM(ADVBBAL_CHARGE_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_CR_OPBAL,
SUM(ADVBBAL_CHARGE_AC_CR_OPBAL-ADVBBAL_CHARGE_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_OPBAL
FROM(
SELECT LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH, SUM(TRANADV_PRIN_AC_AMT_DR) ADVBBAL_PRIN_AC_DB_OPBAL, SUM(TRANADV_PRIN_AC_AMT_CR) ADVBBAL_PRIN_AC_CR_OPBAL, 
(SUM(TRANADV_PRIN_AC_AMT_CR) -SUM(TRANADV_PRIN_AC_AMT_DR)) TRANADV_PRIN_AC_AMT_OS,
SUM(TRANADV_INTRD_AC_AMT_DR) ADVBBAL_INTRD_AC_DB_OPBAL,SUM(TRANADV_INTRD_AC_AMT_CR) ADVBBAL_INTRD_AC_CR_OPBAL,
(SUM(TRANADV_INTRD_AC_AMT_CR)-SUM(TRANADV_INTRD_AC_AMT_DR)) TRANADV_INTRD_AC_AMT_OS,  
SUM(TRANADV_CHARGE_AC_AMT_DR) ADVBBAL_CHARGE_AC_DB_OPBAL, SUM(TRANADV_CHARGE_AC_AMT_CR) ADVBBAL_CHARGE_AC_CR_OPBAL,
(SUM(TRANADV_CHARGE_AC_AMT_CR) -SUM(TRANADV_CHARGE_AC_AMT_DR)) TRANADV_CHARGE_AC_AMT_OS
FROM(
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2014 T, LOANACNTS L,ACNTS A,  TRANADV2014 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL 
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2015 T, LOANACNTS L,ACNTS A,  TRANADV2015 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL 
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2016 T, LOANACNTS L,ACNTS A,  TRANADV2016 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL 
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2017 T, LOANACNTS L,ACNTS A,  TRANADV2017 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL 
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2018 T, LOANACNTS L,ACNTS A,  TRANADV2018 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL 
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2019 T, LOANACNTS L,ACNTS A,  TRANADV2019 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL 
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2020 T, LOANACNTS L,ACNTS A,  TRANADV2020 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL 
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2021 T, LOANACNTS L,ACNTS A,  TRANADV2021 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL 
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2022 T, LOANACNTS L,ACNTS A,  TRANADV2022 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0)
GROUP BY LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH 
ORDER BY 1,2,3)) TRAN FULL OUTER JOIN (SELECT DISTINCT ADVBBAL_INTERNAL_ACNUM, ADVBBAL_YEAR, ADVBBAL_MONTH
FROM ADVBBAL AD, ACNTS A
WHERE AD.ADVBBAL_INTERNAL_ACNUM=A.ACNTS_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
--AND  ADVBBAL_INTERNAL_ACNUM =10104000001722
AND ADVBBAL_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
ORDER BY ADVBBAL_YEAR, ADVBBAL_MONTH) RECORDS
ON (TRAN.LNACNT_INTERNAL_ACNUM=RECORDS.ADVBBAL_INTERNAL_ACNUM AND TRAN.TRAN_YEAR=RECORDS.ADVBBAL_YEAR AND TRAN.TRAN_MONTH=RECORDS.ADVBBAL_MONTH))
SELECT TADV.ADVBBAL_INTERNAL_ACNUM, TADV.ADVBBAL_YEAR,TADV.ADVBBAL_MONTH, ADV.IACLINK_ACTUAL_ACNUM, ADV.IACLINK_BRN_CODE,  
(CASE WHEN (TADV.ADVBBAL_PRIN_AC_OPBAL<>ADV.ADVBBAL_PRIN_AC_OPBAL) THEN 'PO' 
         WHEN  (TADV.ADVBBAL_INTRD_AC_OPBAL<>ADV.ADVBBAL_INTRD_AC_OPBAL) THEN 'IO'
         WHEN (TADV.ADVBBAL_CHARGE_AC_OPBAL<>ADV.ADVBBAL_CHARGE_AC_OPBAL) THEN 'CO'
         WHEN (TADV.ADVBBAL_PRIN_AC_DB_OPBAL<>ADV.ADVBBAL_PRIN_AC_DB_OPBAL) THEN 'PD'
         WHEN (TADV.ADVBBAL_PRIN_AC_CR_OPBAL<>ADV.ADVBBAL_PRIN_AC_CR_OPBAL) THEN 'PC'
         WHEN (TADV.ADVBBAL_INTRD_AC_DB_OPBAL<>ADV.ADVBBAL_INTRD_AC_DB_OPBAL) THEN 'ID'
         WHEN (TADV.ADVBBAL_INTRD_AC_CR_OPBAL<>ADV.ADVBBAL_INTRD_AC_CR_OPBAL) THEN 'IC'
         WHEN (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL<>ADV.ADVBBAL_CHARGE_AC_DB_OPBAL) THEN 'CD'
         WHEN (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL<>ADV.ADVBBAL_CHARGE_AC_CR_OPBAL) THEN 'CC'
         ELSE 'NA' END ) DIFFERENCE, TADV.ADVBBAL_PRIN_AC_OPBAL,ADV.ADVBBAL_PRIN_AC_OPBAL VADVBBAL_PRIN_AC_OPBAL,
         TADV.ADVBBAL_INTRD_AC_OPBAL,ADV.ADVBBAL_INTRD_AC_OPBAL VADVBBAL_INTRD_AC_OPBAL, TADV.ADVBBAL_CHARGE_AC_OPBAL, 
         ADV.ADVBBAL_CHARGE_AC_OPBAL VADVBBAL_CHARGE_AC_OPBAL,TADV.ADVBBAL_PRIN_AC_DB_OPBAL,ADV.ADVBBAL_PRIN_AC_DB_OPBAL VADVBBAL_PRIN_AC_DB_OPBAL,  
         TADV.ADVBBAL_PRIN_AC_CR_OPBAL, ADV.ADVBBAL_PRIN_AC_CR_OPBAL VADVBBAL_PRIN_AC_CR_OPBAL, TADV.ADVBBAL_INTRD_AC_DB_OPBAL,
         ADV.ADVBBAL_INTRD_AC_DB_OPBAL VADVBBAL_INTRD_AC_DB_OPBAL, TADV.ADVBBAL_INTRD_AC_CR_OPBAL,  ADV.ADVBBAL_INTRD_AC_CR_OPBAL  VADVBBAL_INTRD_AC_CR_OPBAL,
         TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,ADV.ADVBBAL_CHARGE_AC_DB_OPBAL VADVBBAL_CHARGE_AC_DB_OPBAL,TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,
          ADV.ADVBBAL_CHARGE_AC_CR_OPBAL VADVBBAL_CHARGE_AC_CR_OPBAL
FROM(
SELECT TADV.ADVBBAL_INTERNAL_ACNUM, TADV.ADVBBAL_YEAR,TADV.ADVBBAL_MONTH, 
NVL(TADV.ADVBBAL_PRIN_AC_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_OPBAL, 
NVL(TADV.ADVBBAL_PRIN_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_PRIN_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_CR_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_CR_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_CR_OPBAL
 FROM TRAN_LOAN_ADVBAL TADV) TADV, (SELECT ADVBBAL_INTERNAL_ACNUM, IA.IACLINK_ACTUAL_ACNUM, IA.IACLINK_BRN_CODE, ADVBBAL_YEAR, ADVBBAL_MONTH, ADVBBAL_PRIN_AC_OPBAL, 
 ADVBBAL_INTRD_AC_OPBAL, ADVBBAL_CHARGE_AC_OPBAL, ADVBBAL_PRIN_AC_DB_OPBAL, ADVBBAL_PRIN_AC_CR_OPBAL, ADVBBAL_INTRD_AC_DB_OPBAL, 
 ADVBBAL_INTRD_AC_CR_OPBAL, ADVBBAL_CHARGE_AC_DB_OPBAL, ADVBBAL_CHARGE_AC_CR_OPBAL
FROM ADVBBAL AD, ACNTS A, IACLINK IA
WHERE AD.ADVBBAL_INTERNAL_ACNUM=A.ACNTS_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=IA.IACLINK_INTERNAL_ACNUM
AND AD.ADVBBAL_INTERNAL_ACNUM=IA.IACLINK_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
) ADV 
WHERE TADV.ADVBBAL_INTERNAL_ACNUM=ADV.ADVBBAL_INTERNAL_ACNUM
AND TADV.ADVBBAL_YEAR=ADV.ADVBBAL_YEAR
AND TADV.ADVBBAL_MONTH=ADV.ADVBBAL_MONTH
AND ((TADV.ADVBBAL_PRIN_AC_OPBAL<>ADV.ADVBBAL_PRIN_AC_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_OPBAL<>ADV.ADVBBAL_INTRD_AC_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_OPBAL<>ADV.ADVBBAL_CHARGE_AC_OPBAL)
         OR (TADV.ADVBBAL_PRIN_AC_DB_OPBAL<>ADV.ADVBBAL_PRIN_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_PRIN_AC_CR_OPBAL<>ADV.ADVBBAL_PRIN_AC_CR_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_DB_OPBAL<>ADV.ADVBBAL_INTRD_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_CR_OPBAL<>ADV.ADVBBAL_INTRD_AC_CR_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL<>ADV.ADVBBAL_CHARGE_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL<>ADV.ADVBBAL_CHARGE_AC_CR_OPBAL))
ORDER BY 1,2,3)
LOOP
UPDATE ADVBBAL
SET ADVBBAL_PRIN_AC_OPBAL=IND.ADVBBAL_PRIN_AC_OPBAL, ADVBBAL_PRIN_BC_OPBAL=IND.ADVBBAL_PRIN_AC_OPBAL,
        ADVBBAL_INTRD_AC_OPBAL=IND.ADVBBAL_INTRD_AC_OPBAL, ADVBBAL_INTRD_BC_OPBAL=IND.ADVBBAL_INTRD_AC_OPBAL,
        ADVBBAL_CHARGE_AC_OPBAL=IND.ADVBBAL_CHARGE_AC_OPBAL, ADVBBAL_CHARGE_BC_OPBAL=IND.ADVBBAL_CHARGE_AC_OPBAL,
        ADVBBAL_PRIN_AC_DB_OPBAL=IND.ADVBBAL_PRIN_AC_DB_OPBAL, ADVBBAL_PRIN_BC_DB_OPBAL=IND.ADVBBAL_PRIN_AC_DB_OPBAL,
        ADVBBAL_PRIN_AC_CR_OPBAL=IND.ADVBBAL_PRIN_AC_CR_OPBAL,ADVBBAL_PRIN_BC_CR_OPBAL=IND.ADVBBAL_PRIN_AC_CR_OPBAL,
        ADVBBAL_INTRD_AC_DB_OPBAL=IND.ADVBBAL_INTRD_AC_DB_OPBAL, ADVBBAL_INTRD_BC_DB_OPBAL=IND.ADVBBAL_INTRD_AC_DB_OPBAL,
        ADVBBAL_INTRD_AC_CR_OPBAL=IND.ADVBBAL_INTRD_AC_CR_OPBAL, ADVBBAL_INTRD_BC_CR_OPBAL=IND.ADVBBAL_INTRD_AC_CR_OPBAL,
        ADVBBAL_CHARGE_AC_DB_OPBAL=IND.ADVBBAL_CHARGE_AC_DB_OPBAL, ADVBBAL_CHARGE_BC_DB_OPBAL=IND.ADVBBAL_CHARGE_AC_DB_OPBAL,
        ADVBBAL_CHARGE_AC_CR_OPBAL=IND.ADVBBAL_CHARGE_AC_CR_OPBAL, ADVBBAL_CHARGE_BC_CR_OPBAL=IND.ADVBBAL_CHARGE_AC_CR_OPBAL
WHERE ADVBBAL_INTERNAL_ACNUM=IND.ADVBBAL_INTERNAL_ACNUM
AND ADVBBAL_YEAR=IND.ADVBBAL_YEAR
AND ADVBBAL_MONTH=IND.ADVBBAL_MONTH;

END LOOP;
END;

--------------------- update ADVVDBBAL ----------------------------------

BEGIN
FOR IND IN (
WITH  TRAN_LOAN_ADVBAL AS(
SELECT NVL(LNACNT_INTERNAL_ACNUM,RECORDS.ADVBBAL_INTERNAL_ACNUM) ADVBBAL_INTERNAL_ACNUM,  NVL(TRAN_YEAR,RECORDS.ADVBBAL_YEAR) ADVBBAL_YEAR,  NVL(TRAN_MONTH,RECORDS.ADVBBAL_MONTH) ADVBBAL_MONTH,  
TRANADV_PRIN_AC_AMT_OS, ADVBBAL_PRIN_AC_OPBAL, ADVBBAL_INTRD_AC_OPBAL, ADVBBAL_CHARGE_AC_OPBAL, ADVBBAL_PRIN_AC_DB_OPBAL, ADVBBAL_PRIN_AC_CR_OPBAL, 
ADVBBAL_INTRD_AC_DB_OPBAL, ADVBBAL_INTRD_AC_CR_OPBAL, ADVBBAL_CHARGE_AC_DB_OPBAL, ADVBBAL_CHARGE_AC_CR_OPBAL
FROM (SELECT LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH,  TRANADV_PRIN_AC_AMT_OS, 
SUM(ADVBBAL_PRIN_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_DB_OPBAL,
SUM(ADVBBAL_PRIN_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_CR_OPBAL,
SUM(ADVBBAL_PRIN_AC_CR_OPBAL-ADVBBAL_PRIN_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_OPBAL,
SUM(ADVBBAL_INTRD_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_DB_OPBAL,
SUM(ADVBBAL_INTRD_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_CR_OPBAL,
SUM(ADVBBAL_INTRD_AC_CR_OPBAL-ADVBBAL_INTRD_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_OPBAL,
SUM(ADVBBAL_CHARGE_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_DB_OPBAL,
SUM(ADVBBAL_CHARGE_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_CR_OPBAL,
SUM(ADVBBAL_CHARGE_AC_CR_OPBAL-ADVBBAL_CHARGE_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_OPBAL
FROM(
SELECT LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH, SUM(TRANADV_PRIN_AC_AMT_DR) ADVBBAL_PRIN_AC_DB_OPBAL, SUM(TRANADV_PRIN_AC_AMT_CR) ADVBBAL_PRIN_AC_CR_OPBAL, 
(SUM(TRANADV_PRIN_AC_AMT_CR) -SUM(TRANADV_PRIN_AC_AMT_DR)) TRANADV_PRIN_AC_AMT_OS,
SUM(TRANADV_INTRD_AC_AMT_DR) ADVBBAL_INTRD_AC_DB_OPBAL,SUM(TRANADV_INTRD_AC_AMT_CR) ADVBBAL_INTRD_AC_CR_OPBAL,
(SUM(TRANADV_INTRD_AC_AMT_CR)-SUM(TRANADV_INTRD_AC_AMT_DR)) TRANADV_INTRD_AC_AMT_OS,  
SUM(TRANADV_CHARGE_AC_AMT_DR) ADVBBAL_CHARGE_AC_DB_OPBAL, SUM(TRANADV_CHARGE_AC_AMT_CR) ADVBBAL_CHARGE_AC_CR_OPBAL,
(SUM(TRANADV_CHARGE_AC_AMT_CR) -SUM(TRANADV_CHARGE_AC_AMT_DR)) TRANADV_CHARGE_AC_AMT_OS
FROM(
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2014 T, LOANACNTS L,ACNTS A,  TRANADV2014 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2015 T, LOANACNTS L,ACNTS A,  TRANADV2015 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2016 T, LOANACNTS L,ACNTS A,  TRANADV2016 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2017 T, LOANACNTS L,ACNTS A,  TRANADV2017 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2018 T, LOANACNTS L,ACNTS A,  TRANADV2018 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2019 T, LOANACNTS L,ACNTS A,  TRANADV2019 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2020 T, LOANACNTS L,ACNTS A,  TRANADV2020 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2021 T, LOANACNTS L,ACNTS A,  TRANADV2021 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2022 T, LOANACNTS L,ACNTS A,  TRANADV2022 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0)
GROUP BY LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH 
ORDER BY 1,2,3)) TRAN FULL OUTER JOIN (SELECT DISTINCT ADVBBAL_INTERNAL_ACNUM, ADVBBAL_YEAR, ADVBBAL_MONTH
FROM ADVBBAL AD, ACNTS A
WHERE AD.ADVBBAL_INTERNAL_ACNUM=A.ACNTS_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
--AND  ADVBBAL_INTERNAL_ACNUM =10104000001722
AND ADVBBAL_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
ORDER BY ADVBBAL_YEAR, ADVBBAL_MONTH) RECORDS
ON (TRAN.LNACNT_INTERNAL_ACNUM=RECORDS.ADVBBAL_INTERNAL_ACNUM AND TRAN.TRAN_YEAR=RECORDS.ADVBBAL_YEAR AND TRAN.TRAN_MONTH=RECORDS.ADVBBAL_MONTH))
SELECT TADV.ADVBBAL_INTERNAL_ACNUM, TADV.ADVBBAL_YEAR,TADV.ADVBBAL_MONTH, ADV.IACLINK_ACTUAL_ACNUM, ADV.IACLINK_BRN_CODE,  
(CASE WHEN (TADV.ADVBBAL_PRIN_AC_OPBAL<>ADV.ADVBBAL_PRIN_AC_OPBAL) THEN 'PO' 
         WHEN  (TADV.ADVBBAL_INTRD_AC_OPBAL<>ADV.ADVBBAL_INTRD_AC_OPBAL) THEN 'IO'
         WHEN (TADV.ADVBBAL_CHARGE_AC_OPBAL<>ADV.ADVBBAL_CHARGE_AC_OPBAL) THEN 'CO'
         WHEN (TADV.ADVBBAL_PRIN_AC_DB_OPBAL<>ADV.ADVBBAL_PRIN_AC_DB_OPBAL) THEN 'PD'
         WHEN (TADV.ADVBBAL_PRIN_AC_CR_OPBAL<>ADV.ADVBBAL_PRIN_AC_CR_OPBAL) THEN 'PC'
         WHEN (TADV.ADVBBAL_INTRD_AC_DB_OPBAL<>ADV.ADVBBAL_INTRD_AC_DB_OPBAL) THEN 'ID'
         WHEN (TADV.ADVBBAL_INTRD_AC_CR_OPBAL<>ADV.ADVBBAL_INTRD_AC_CR_OPBAL) THEN 'IC'
         WHEN (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL<>ADV.ADVBBAL_CHARGE_AC_DB_OPBAL) THEN 'CD'
         WHEN (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL<>ADV.ADVBBAL_CHARGE_AC_CR_OPBAL) THEN 'CC'
         ELSE 'NA' END ) DIFFERENCE, TADV.ADVBBAL_PRIN_AC_OPBAL,ADV.ADVBBAL_PRIN_AC_OPBAL VADVBBAL_PRIN_AC_OPBAL,
         TADV.ADVBBAL_INTRD_AC_OPBAL,ADV.ADVBBAL_INTRD_AC_OPBAL VADVBBAL_INTRD_AC_OPBAL, TADV.ADVBBAL_CHARGE_AC_OPBAL, 
         ADV.ADVBBAL_CHARGE_AC_OPBAL VADVBBAL_CHARGE_AC_OPBAL,TADV.ADVBBAL_PRIN_AC_DB_OPBAL,ADV.ADVBBAL_PRIN_AC_DB_OPBAL VADVBBAL_PRIN_AC_DB_OPBAL,  
         TADV.ADVBBAL_PRIN_AC_CR_OPBAL, ADV.ADVBBAL_PRIN_AC_CR_OPBAL VADVBBAL_PRIN_AC_CR_OPBAL, TADV.ADVBBAL_INTRD_AC_DB_OPBAL,
         ADV.ADVBBAL_INTRD_AC_DB_OPBAL VADVBBAL_INTRD_AC_DB_OPBAL, TADV.ADVBBAL_INTRD_AC_CR_OPBAL,  ADV.ADVBBAL_INTRD_AC_CR_OPBAL  VADVBBAL_INTRD_AC_CR_OPBAL,
         TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,ADV.ADVBBAL_CHARGE_AC_DB_OPBAL VADVBBAL_CHARGE_AC_DB_OPBAL,TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,
          ADV.ADVBBAL_CHARGE_AC_CR_OPBAL VADVBBAL_CHARGE_AC_CR_OPBAL
FROM(
SELECT TADV.ADVBBAL_INTERNAL_ACNUM, TADV.ADVBBAL_YEAR,TADV.ADVBBAL_MONTH, 
NVL(TADV.ADVBBAL_PRIN_AC_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_OPBAL, 
NVL(TADV.ADVBBAL_PRIN_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_PRIN_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_CR_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_CR_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_CR_OPBAL
 FROM TRAN_LOAN_ADVBAL TADV) TADV, (SELECT ADVBBAL_INTERNAL_ACNUM, IA.IACLINK_ACTUAL_ACNUM, IA.IACLINK_BRN_CODE, ADVBBAL_YEAR, ADVBBAL_MONTH, ADVBBAL_PRIN_AC_OPBAL, 
 ADVBBAL_INTRD_AC_OPBAL, ADVBBAL_CHARGE_AC_OPBAL, ADVBBAL_PRIN_AC_DB_OPBAL, ADVBBAL_PRIN_AC_CR_OPBAL, ADVBBAL_INTRD_AC_DB_OPBAL, 
 ADVBBAL_INTRD_AC_CR_OPBAL, ADVBBAL_CHARGE_AC_DB_OPBAL, ADVBBAL_CHARGE_AC_CR_OPBAL
FROM ADVBBAL AD, ACNTS A, IACLINK IA
WHERE AD.ADVBBAL_INTERNAL_ACNUM=A.ACNTS_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=IA.IACLINK_INTERNAL_ACNUM
AND AD.ADVBBAL_INTERNAL_ACNUM=IA.IACLINK_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
) ADV 
WHERE TADV.ADVBBAL_INTERNAL_ACNUM=ADV.ADVBBAL_INTERNAL_ACNUM
AND TADV.ADVBBAL_YEAR=ADV.ADVBBAL_YEAR
AND TADV.ADVBBAL_MONTH=ADV.ADVBBAL_MONTH
AND ((TADV.ADVBBAL_PRIN_AC_OPBAL<>ADV.ADVBBAL_PRIN_AC_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_OPBAL<>ADV.ADVBBAL_INTRD_AC_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_OPBAL<>ADV.ADVBBAL_CHARGE_AC_OPBAL)
         OR (TADV.ADVBBAL_PRIN_AC_DB_OPBAL<>ADV.ADVBBAL_PRIN_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_PRIN_AC_CR_OPBAL<>ADV.ADVBBAL_PRIN_AC_CR_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_DB_OPBAL<>ADV.ADVBBAL_INTRD_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_CR_OPBAL<>ADV.ADVBBAL_INTRD_AC_CR_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL<>ADV.ADVBBAL_CHARGE_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL<>ADV.ADVBBAL_CHARGE_AC_CR_OPBAL))
ORDER BY 1,2,3)
LOOP
UPDATE ADVVDBBAL
SET ADVVDBBAL_PRIN_AC_OPBAL=IND.ADVBBAL_PRIN_AC_OPBAL, ADVVDBBAL_PRIN_BC_OPBAL=IND.ADVBBAL_PRIN_AC_OPBAL,
    ADVVDBBAL_INTRD_AC_OPBAL=IND.ADVBBAL_INTRD_AC_OPBAL, ADVVDBBAL_INTRD_BC_OPBAL=IND.ADVBBAL_INTRD_AC_OPBAL,
    ADVVDBBAL_CHARGE_AC_OPBAL=IND.ADVBBAL_CHARGE_AC_OPBAL, ADVVDBBAL_CHARGE_BC_OPBAL=IND.ADVBBAL_CHARGE_AC_OPBAL
WHERE ADVVDBBAL_INTERNAL_ACNUM=IND.ADVBBAL_INTERNAL_ACNUM
AND ADVVDBBAL_YEAR=IND.ADVBBAL_YEAR
AND ADVVDBBAL_MONTH=IND.ADVBBAL_MONTH;

END LOOP;
END;

--------------------- update ADVVDBBAL ----------------------------------


BEGIN
FOR IND IN (
WITH  TRAN_LOAN_ADVBAL AS(
SELECT NVL(LNACNT_INTERNAL_ACNUM,RECORDS.ADVBBAL_INTERNAL_ACNUM) ADVBBAL_INTERNAL_ACNUM,  NVL(TRAN_YEAR,RECORDS.ADVBBAL_YEAR) ADVBBAL_YEAR,  NVL(TRAN_MONTH,RECORDS.ADVBBAL_MONTH) ADVBBAL_MONTH,  
TRANADV_PRIN_AC_AMT_OS, ADVBBAL_PRIN_AC_OPBAL, ADVBBAL_INTRD_AC_OPBAL, ADVBBAL_CHARGE_AC_OPBAL, ADVBBAL_PRIN_AC_DB_OPBAL, ADVBBAL_PRIN_AC_CR_OPBAL, 
ADVBBAL_INTRD_AC_DB_OPBAL, ADVBBAL_INTRD_AC_CR_OPBAL, ADVBBAL_CHARGE_AC_DB_OPBAL, ADVBBAL_CHARGE_AC_CR_OPBAL
FROM (SELECT LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH,  TRANADV_PRIN_AC_AMT_OS, 
SUM(ADVBBAL_PRIN_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_DB_OPBAL,
SUM(ADVBBAL_PRIN_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_CR_OPBAL,
SUM(ADVBBAL_PRIN_AC_CR_OPBAL-ADVBBAL_PRIN_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_OPBAL,
SUM(ADVBBAL_INTRD_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_DB_OPBAL,
SUM(ADVBBAL_INTRD_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_CR_OPBAL,
SUM(ADVBBAL_INTRD_AC_CR_OPBAL-ADVBBAL_INTRD_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_OPBAL,
SUM(ADVBBAL_CHARGE_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_DB_OPBAL,
SUM(ADVBBAL_CHARGE_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_CR_OPBAL,
SUM(ADVBBAL_CHARGE_AC_CR_OPBAL-ADVBBAL_CHARGE_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_OPBAL
FROM(
SELECT LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH, SUM(TRANADV_PRIN_AC_AMT_DR) ADVBBAL_PRIN_AC_DB_OPBAL, SUM(TRANADV_PRIN_AC_AMT_CR) ADVBBAL_PRIN_AC_CR_OPBAL, 
(SUM(TRANADV_PRIN_AC_AMT_CR) -SUM(TRANADV_PRIN_AC_AMT_DR)) TRANADV_PRIN_AC_AMT_OS,
SUM(TRANADV_INTRD_AC_AMT_DR) ADVBBAL_INTRD_AC_DB_OPBAL,SUM(TRANADV_INTRD_AC_AMT_CR) ADVBBAL_INTRD_AC_CR_OPBAL,
(SUM(TRANADV_INTRD_AC_AMT_CR)-SUM(TRANADV_INTRD_AC_AMT_DR)) TRANADV_INTRD_AC_AMT_OS,  
SUM(TRANADV_CHARGE_AC_AMT_DR) ADVBBAL_CHARGE_AC_DB_OPBAL, SUM(TRANADV_CHARGE_AC_AMT_CR) ADVBBAL_CHARGE_AC_CR_OPBAL,
(SUM(TRANADV_CHARGE_AC_AMT_CR) -SUM(TRANADV_CHARGE_AC_AMT_DR)) TRANADV_CHARGE_AC_AMT_OS
FROM(
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2014 T, LOANACNTS L,ACNTS A,  TRANADV2014 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2015 T, LOANACNTS L,ACNTS A,  TRANADV2015 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2016 T, LOANACNTS L,ACNTS A,  TRANADV2016 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2017 T, LOANACNTS L,ACNTS A,  TRANADV2017 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2018 T, LOANACNTS L,ACNTS A,  TRANADV2018 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2019 T, LOANACNTS L,ACNTS A,  TRANADV2019 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2020 T, LOANACNTS L,ACNTS A,  TRANADV2020 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2021 T, LOANACNTS L,ACNTS A,  TRANADV2021 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2022 T, LOANACNTS L,ACNTS A,  TRANADV2022 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0  )
GROUP BY LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH 
ORDER BY 1,2,3)) TRAN FULL OUTER JOIN (SELECT DISTINCT ADVBBAL_INTERNAL_ACNUM, ADVBBAL_YEAR, ADVBBAL_MONTH
FROM ADVBBAL AD, ACNTS A
WHERE AD.ADVBBAL_INTERNAL_ACNUM=A.ACNTS_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
--AND  ADVBBAL_INTERNAL_ACNUM =10104000001722
AND ADVBBAL_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
ORDER BY ADVBBAL_YEAR, ADVBBAL_MONTH) RECORDS
ON (TRAN.LNACNT_INTERNAL_ACNUM=RECORDS.ADVBBAL_INTERNAL_ACNUM AND TRAN.TRAN_YEAR=RECORDS.ADVBBAL_YEAR AND TRAN.TRAN_MONTH=RECORDS.ADVBBAL_MONTH))
SELECT TADV.ADVBBAL_INTERNAL_ACNUM, TADV.ADVBBAL_YEAR,TADV.ADVBBAL_MONTH, ADV.IACLINK_ACTUAL_ACNUM, ADV.IACLINK_BRN_CODE,  
(CASE WHEN (TADV.ADVBBAL_PRIN_AC_OPBAL<>ADV.ADVBBAL_PRIN_AC_OPBAL) THEN 'PO' 
         WHEN  (TADV.ADVBBAL_INTRD_AC_OPBAL<>ADV.ADVBBAL_INTRD_AC_OPBAL) THEN 'IO'
         WHEN (TADV.ADVBBAL_CHARGE_AC_OPBAL<>ADV.ADVBBAL_CHARGE_AC_OPBAL) THEN 'CO'
         WHEN (TADV.ADVBBAL_PRIN_AC_DB_OPBAL<>ADV.ADVBBAL_PRIN_AC_DB_OPBAL) THEN 'PD'
         WHEN (TADV.ADVBBAL_PRIN_AC_CR_OPBAL<>ADV.ADVBBAL_PRIN_AC_CR_OPBAL) THEN 'PC'
         WHEN (TADV.ADVBBAL_INTRD_AC_DB_OPBAL<>ADV.ADVBBAL_INTRD_AC_DB_OPBAL) THEN 'ID'
         WHEN (TADV.ADVBBAL_INTRD_AC_CR_OPBAL<>ADV.ADVBBAL_INTRD_AC_CR_OPBAL) THEN 'IC'
         WHEN (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL<>ADV.ADVBBAL_CHARGE_AC_DB_OPBAL) THEN 'CD'
         WHEN (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL<>ADV.ADVBBAL_CHARGE_AC_CR_OPBAL) THEN 'CC'
         ELSE 'NA' END ) DIFFERENCE, TADV.ADVBBAL_PRIN_AC_OPBAL,ADV.ADVBBAL_PRIN_AC_OPBAL VADVBBAL_PRIN_AC_OPBAL,
         TADV.ADVBBAL_INTRD_AC_OPBAL,ADV.ADVBBAL_INTRD_AC_OPBAL VADVBBAL_INTRD_AC_OPBAL, TADV.ADVBBAL_CHARGE_AC_OPBAL, 
         ADV.ADVBBAL_CHARGE_AC_OPBAL VADVBBAL_CHARGE_AC_OPBAL,TADV.ADVBBAL_PRIN_AC_DB_OPBAL,ADV.ADVBBAL_PRIN_AC_DB_OPBAL VADVBBAL_PRIN_AC_DB_OPBAL,  
         TADV.ADVBBAL_PRIN_AC_CR_OPBAL, ADV.ADVBBAL_PRIN_AC_CR_OPBAL VADVBBAL_PRIN_AC_CR_OPBAL, TADV.ADVBBAL_INTRD_AC_DB_OPBAL,
         ADV.ADVBBAL_INTRD_AC_DB_OPBAL VADVBBAL_INTRD_AC_DB_OPBAL, TADV.ADVBBAL_INTRD_AC_CR_OPBAL,  ADV.ADVBBAL_INTRD_AC_CR_OPBAL  VADVBBAL_INTRD_AC_CR_OPBAL,
         TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,ADV.ADVBBAL_CHARGE_AC_DB_OPBAL VADVBBAL_CHARGE_AC_DB_OPBAL,TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,
          ADV.ADVBBAL_CHARGE_AC_CR_OPBAL VADVBBAL_CHARGE_AC_CR_OPBAL
FROM(
SELECT TADV.ADVBBAL_INTERNAL_ACNUM, TADV.ADVBBAL_YEAR,TADV.ADVBBAL_MONTH, 
NVL(TADV.ADVBBAL_PRIN_AC_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_OPBAL, 
NVL(TADV.ADVBBAL_PRIN_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_PRIN_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_CR_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_CR_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_CR_OPBAL
 FROM TRAN_LOAN_ADVBAL TADV) TADV, (SELECT ADVBBAL_INTERNAL_ACNUM, IA.IACLINK_ACTUAL_ACNUM, IA.IACLINK_BRN_CODE, ADVBBAL_YEAR, ADVBBAL_MONTH, ADVBBAL_PRIN_AC_OPBAL, 
 ADVBBAL_INTRD_AC_OPBAL, ADVBBAL_CHARGE_AC_OPBAL, ADVBBAL_PRIN_AC_DB_OPBAL, ADVBBAL_PRIN_AC_CR_OPBAL, ADVBBAL_INTRD_AC_DB_OPBAL, 
 ADVBBAL_INTRD_AC_CR_OPBAL, ADVBBAL_CHARGE_AC_DB_OPBAL, ADVBBAL_CHARGE_AC_CR_OPBAL
FROM ADVBBAL AD, ACNTS A, IACLINK IA
WHERE AD.ADVBBAL_INTERNAL_ACNUM=A.ACNTS_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=IA.IACLINK_INTERNAL_ACNUM
AND AD.ADVBBAL_INTERNAL_ACNUM=IA.IACLINK_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
) ADV 
WHERE TADV.ADVBBAL_INTERNAL_ACNUM=ADV.ADVBBAL_INTERNAL_ACNUM
AND TADV.ADVBBAL_YEAR=ADV.ADVBBAL_YEAR
AND TADV.ADVBBAL_MONTH=ADV.ADVBBAL_MONTH
AND ((TADV.ADVBBAL_PRIN_AC_OPBAL<>ADV.ADVBBAL_PRIN_AC_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_OPBAL<>ADV.ADVBBAL_INTRD_AC_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_OPBAL<>ADV.ADVBBAL_CHARGE_AC_OPBAL)
         OR (TADV.ADVBBAL_PRIN_AC_DB_OPBAL<>ADV.ADVBBAL_PRIN_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_PRIN_AC_CR_OPBAL<>ADV.ADVBBAL_PRIN_AC_CR_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_DB_OPBAL<>ADV.ADVBBAL_INTRD_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_CR_OPBAL<>ADV.ADVBBAL_INTRD_AC_CR_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL<>ADV.ADVBBAL_CHARGE_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL<>ADV.ADVBBAL_CHARGE_AC_CR_OPBAL))
ORDER BY 1,2,3)
LOOP
UPDATE ADVVDBBAL
SET ADVVDBBAL_PRIN_AC_OPBAL=IND.ADVBBAL_PRIN_AC_OPBAL, ADVVDBBAL_PRIN_BC_OPBAL=IND.ADVBBAL_PRIN_AC_OPBAL,
    ADVVDBBAL_INTRD_AC_OPBAL=IND.ADVBBAL_INTRD_AC_OPBAL, ADVVDBBAL_INTRD_BC_OPBAL=IND.ADVBBAL_INTRD_AC_OPBAL,
    ADVVDBBAL_CHARGE_AC_OPBAL=IND.ADVBBAL_CHARGE_AC_OPBAL, ADVVDBBAL_CHARGE_BC_OPBAL=IND.ADVBBAL_CHARGE_AC_OPBAL
WHERE ADVVDBBAL_INTERNAL_ACNUM=IND.ADVBBAL_INTERNAL_ACNUM
AND ADVVDBBAL_YEAR=IND.ADVBBAL_YEAR
AND ADVVDBBAL_MONTH=IND.ADVBBAL_MONTH;

END LOOP;
END;


------------------- UPDATE ACNTVDBBAL -----------------------

BEGIN
FOR IND IN (
WITH  TRAN_LOAN_ADVBAL AS(
SELECT NVL(LNACNT_INTERNAL_ACNUM,RECORDS.ADVBBAL_INTERNAL_ACNUM) ADVBBAL_INTERNAL_ACNUM,  NVL(TRAN_YEAR,RECORDS.ADVBBAL_YEAR) ADVBBAL_YEAR,  NVL(TRAN_MONTH,RECORDS.ADVBBAL_MONTH) ADVBBAL_MONTH,  
TRANADV_PRIN_AC_AMT_OS, ADVBBAL_PRIN_AC_OPBAL, ADVBBAL_INTRD_AC_OPBAL, ADVBBAL_CHARGE_AC_OPBAL, ADVBBAL_PRIN_AC_DB_OPBAL, ADVBBAL_PRIN_AC_CR_OPBAL, 
ADVBBAL_INTRD_AC_DB_OPBAL, ADVBBAL_INTRD_AC_CR_OPBAL, ADVBBAL_CHARGE_AC_DB_OPBAL, ADVBBAL_CHARGE_AC_CR_OPBAL
FROM (SELECT LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH,  TRANADV_PRIN_AC_AMT_OS, 
SUM(ADVBBAL_PRIN_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_DB_OPBAL,
SUM(ADVBBAL_PRIN_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_CR_OPBAL,
SUM(ADVBBAL_PRIN_AC_CR_OPBAL-ADVBBAL_PRIN_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_OPBAL,
SUM(ADVBBAL_INTRD_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_DB_OPBAL,
SUM(ADVBBAL_INTRD_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_CR_OPBAL,
SUM(ADVBBAL_INTRD_AC_CR_OPBAL-ADVBBAL_INTRD_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_OPBAL,
SUM(ADVBBAL_CHARGE_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_DB_OPBAL,
SUM(ADVBBAL_CHARGE_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_CR_OPBAL,
SUM(ADVBBAL_CHARGE_AC_CR_OPBAL-ADVBBAL_CHARGE_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_OPBAL
FROM(
SELECT LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH, SUM(TRANADV_PRIN_AC_AMT_DR) ADVBBAL_PRIN_AC_DB_OPBAL, SUM(TRANADV_PRIN_AC_AMT_CR) ADVBBAL_PRIN_AC_CR_OPBAL, 
(SUM(TRANADV_PRIN_AC_AMT_CR) -SUM(TRANADV_PRIN_AC_AMT_DR)) TRANADV_PRIN_AC_AMT_OS,
SUM(TRANADV_INTRD_AC_AMT_DR) ADVBBAL_INTRD_AC_DB_OPBAL,SUM(TRANADV_INTRD_AC_AMT_CR) ADVBBAL_INTRD_AC_CR_OPBAL,
(SUM(TRANADV_INTRD_AC_AMT_CR)-SUM(TRANADV_INTRD_AC_AMT_DR)) TRANADV_INTRD_AC_AMT_OS,  
SUM(TRANADV_CHARGE_AC_AMT_DR) ADVBBAL_CHARGE_AC_DB_OPBAL, SUM(TRANADV_CHARGE_AC_AMT_CR) ADVBBAL_CHARGE_AC_CR_OPBAL,
(SUM(TRANADV_CHARGE_AC_AMT_CR) -SUM(TRANADV_CHARGE_AC_AMT_DR)) TRANADV_CHARGE_AC_AMT_OS
FROM(
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2014 T, LOANACNTS L,ACNTS A,  TRANADV2014 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2015 T, LOANACNTS L,ACNTS A,  TRANADV2015 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2016 T, LOANACNTS L,ACNTS A,  TRANADV2016 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2017 T, LOANACNTS L,ACNTS A,  TRANADV2017 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2018 T, LOANACNTS L,ACNTS A,  TRANADV2018 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2019 T, LOANACNTS L,ACNTS A,  TRANADV2019 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2020 T, LOANACNTS L,ACNTS A,  TRANADV2020 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2021 T, LOANACNTS L,ACNTS A,  TRANADV2021 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2022 T, LOANACNTS L,ACNTS A,  TRANADV2022 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0)
GROUP BY LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH 
ORDER BY 1,2,3)) TRAN FULL OUTER JOIN (SELECT DISTINCT ADVBBAL_INTERNAL_ACNUM, ADVBBAL_YEAR, ADVBBAL_MONTH
FROM ADVBBAL AD, ACNTS A
WHERE AD.ADVBBAL_INTERNAL_ACNUM=A.ACNTS_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
--AND  ADVBBAL_INTERNAL_ACNUM =10104000001722
AND ADVBBAL_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
ORDER BY ADVBBAL_YEAR, ADVBBAL_MONTH) RECORDS
ON (TRAN.LNACNT_INTERNAL_ACNUM=RECORDS.ADVBBAL_INTERNAL_ACNUM AND TRAN.TRAN_YEAR=RECORDS.ADVBBAL_YEAR AND TRAN.TRAN_MONTH=RECORDS.ADVBBAL_MONTH))
SELECT TADV.ADVBBAL_INTERNAL_ACNUM, TADV.ADVBBAL_YEAR,TADV.ADVBBAL_MONTH, ADV.IACLINK_ACTUAL_ACNUM, ADV.IACLINK_BRN_CODE,  
(CASE WHEN (TADV.ADVBBAL_PRIN_AC_OPBAL<>ADV.ADVBBAL_PRIN_AC_OPBAL) THEN 'PO' 
         WHEN  (TADV.ADVBBAL_INTRD_AC_OPBAL<>ADV.ADVBBAL_INTRD_AC_OPBAL) THEN 'IO'
         WHEN (TADV.ADVBBAL_CHARGE_AC_OPBAL<>ADV.ADVBBAL_CHARGE_AC_OPBAL) THEN 'CO'
         WHEN (TADV.ADVBBAL_PRIN_AC_DB_OPBAL<>ADV.ADVBBAL_PRIN_AC_DB_OPBAL) THEN 'PD'
         WHEN (TADV.ADVBBAL_PRIN_AC_CR_OPBAL<>ADV.ADVBBAL_PRIN_AC_CR_OPBAL) THEN 'PC'
         WHEN (TADV.ADVBBAL_INTRD_AC_DB_OPBAL<>ADV.ADVBBAL_INTRD_AC_DB_OPBAL) THEN 'ID'
         WHEN (TADV.ADVBBAL_INTRD_AC_CR_OPBAL<>ADV.ADVBBAL_INTRD_AC_CR_OPBAL) THEN 'IC'
         WHEN (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL<>ADV.ADVBBAL_CHARGE_AC_DB_OPBAL) THEN 'CD'
         WHEN (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL<>ADV.ADVBBAL_CHARGE_AC_CR_OPBAL) THEN 'CC'
         ELSE 'NA' END ) DIFFERENCE, TADV.ADVBBAL_PRIN_AC_OPBAL,ADV.ADVBBAL_PRIN_AC_OPBAL VADVBBAL_PRIN_AC_OPBAL,
         TADV.ADVBBAL_INTRD_AC_OPBAL,ADV.ADVBBAL_INTRD_AC_OPBAL VADVBBAL_INTRD_AC_OPBAL, TADV.ADVBBAL_CHARGE_AC_OPBAL, 
         ADV.ADVBBAL_CHARGE_AC_OPBAL VADVBBAL_CHARGE_AC_OPBAL,TADV.ADVBBAL_PRIN_AC_DB_OPBAL,ADV.ADVBBAL_PRIN_AC_DB_OPBAL VADVBBAL_PRIN_AC_DB_OPBAL,  
         TADV.ADVBBAL_PRIN_AC_CR_OPBAL, ADV.ADVBBAL_PRIN_AC_CR_OPBAL VADVBBAL_PRIN_AC_CR_OPBAL, TADV.ADVBBAL_INTRD_AC_DB_OPBAL,
         ADV.ADVBBAL_INTRD_AC_DB_OPBAL VADVBBAL_INTRD_AC_DB_OPBAL, TADV.ADVBBAL_INTRD_AC_CR_OPBAL,  ADV.ADVBBAL_INTRD_AC_CR_OPBAL  VADVBBAL_INTRD_AC_CR_OPBAL,
         TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,ADV.ADVBBAL_CHARGE_AC_DB_OPBAL VADVBBAL_CHARGE_AC_DB_OPBAL,TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,
          ADV.ADVBBAL_CHARGE_AC_CR_OPBAL VADVBBAL_CHARGE_AC_CR_OPBAL
FROM(
SELECT TADV.ADVBBAL_INTERNAL_ACNUM, TADV.ADVBBAL_YEAR,TADV.ADVBBAL_MONTH, 
NVL(TADV.ADVBBAL_PRIN_AC_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_OPBAL, 
NVL(TADV.ADVBBAL_PRIN_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_PRIN_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_CR_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_CR_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_CR_OPBAL
 FROM TRAN_LOAN_ADVBAL TADV) TADV, (SELECT ADVBBAL_INTERNAL_ACNUM, IA.IACLINK_ACTUAL_ACNUM, IA.IACLINK_BRN_CODE, ADVBBAL_YEAR, ADVBBAL_MONTH, ADVBBAL_PRIN_AC_OPBAL, 
 ADVBBAL_INTRD_AC_OPBAL, ADVBBAL_CHARGE_AC_OPBAL, ADVBBAL_PRIN_AC_DB_OPBAL, ADVBBAL_PRIN_AC_CR_OPBAL, ADVBBAL_INTRD_AC_DB_OPBAL, 
 ADVBBAL_INTRD_AC_CR_OPBAL, ADVBBAL_CHARGE_AC_DB_OPBAL, ADVBBAL_CHARGE_AC_CR_OPBAL
FROM ADVBBAL AD, ACNTS A, IACLINK IA
WHERE AD.ADVBBAL_INTERNAL_ACNUM=A.ACNTS_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=IA.IACLINK_INTERNAL_ACNUM
AND AD.ADVBBAL_INTERNAL_ACNUM=IA.IACLINK_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
) ADV 
WHERE TADV.ADVBBAL_INTERNAL_ACNUM=ADV.ADVBBAL_INTERNAL_ACNUM
AND TADV.ADVBBAL_YEAR=ADV.ADVBBAL_YEAR
AND TADV.ADVBBAL_MONTH=ADV.ADVBBAL_MONTH
AND ((TADV.ADVBBAL_PRIN_AC_OPBAL<>ADV.ADVBBAL_PRIN_AC_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_OPBAL<>ADV.ADVBBAL_INTRD_AC_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_OPBAL<>ADV.ADVBBAL_CHARGE_AC_OPBAL)
         OR (TADV.ADVBBAL_PRIN_AC_DB_OPBAL<>ADV.ADVBBAL_PRIN_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_PRIN_AC_CR_OPBAL<>ADV.ADVBBAL_PRIN_AC_CR_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_DB_OPBAL<>ADV.ADVBBAL_INTRD_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_CR_OPBAL<>ADV.ADVBBAL_INTRD_AC_CR_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL<>ADV.ADVBBAL_CHARGE_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL<>ADV.ADVBBAL_CHARGE_AC_CR_OPBAL))
ORDER BY 1,2,3)
LOOP

UPDATE ACNTVDBBAL
SET ACNTVBBAL_AC_OPNG_DB_SUM=IND.ADVBBAL_PRIN_AC_DB_OPBAL+IND.ADVBBAL_INTRD_AC_DB_OPBAL+IND.ADVBBAL_CHARGE_AC_DB_OPBAL, 
        ACNTVBBAL_BC_OPNG_DB_SUM=IND.ADVBBAL_PRIN_AC_DB_OPBAL+IND.ADVBBAL_INTRD_AC_DB_OPBAL+IND.ADVBBAL_CHARGE_AC_DB_OPBAL, 
        ACNTVBBAL_AC_OPNG_CR_SUM=IND.ADVBBAL_PRIN_AC_CR_OPBAL+IND.ADVBBAL_INTRD_AC_CR_OPBAL+IND.ADVBBAL_CHARGE_AC_CR_OPBAL, 
        ACNTVBBAL_BC_OPNG_CR_SUM=IND.ADVBBAL_PRIN_AC_CR_OPBAL+IND.ADVBBAL_INTRD_AC_CR_OPBAL+IND.ADVBBAL_CHARGE_AC_CR_OPBAL
WHERE ACNTVBBAL_INTERNAL_ACNUM=IND.ADVBBAL_INTERNAL_ACNUM
AND ACNTVBBAL_YEAR=IND.ADVBBAL_YEAR
AND ACNTVBBAL_MONTH=IND.ADVBBAL_MONTH;

END LOOP;
END;


------------------- UPDATE ACNTVDBBAL -----------------------


BEGIN
FOR IND IN (
WITH  TRAN_LOAN_ADVBAL AS(
SELECT NVL(LNACNT_INTERNAL_ACNUM,RECORDS.ADVBBAL_INTERNAL_ACNUM) ADVBBAL_INTERNAL_ACNUM,  NVL(TRAN_YEAR,RECORDS.ADVBBAL_YEAR) ADVBBAL_YEAR,  NVL(TRAN_MONTH,RECORDS.ADVBBAL_MONTH) ADVBBAL_MONTH,  
TRANADV_PRIN_AC_AMT_OS, ADVBBAL_PRIN_AC_OPBAL, ADVBBAL_INTRD_AC_OPBAL, ADVBBAL_CHARGE_AC_OPBAL, ADVBBAL_PRIN_AC_DB_OPBAL, ADVBBAL_PRIN_AC_CR_OPBAL, 
ADVBBAL_INTRD_AC_DB_OPBAL, ADVBBAL_INTRD_AC_CR_OPBAL, ADVBBAL_CHARGE_AC_DB_OPBAL, ADVBBAL_CHARGE_AC_CR_OPBAL
FROM (SELECT LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH,  TRANADV_PRIN_AC_AMT_OS, 
SUM(ADVBBAL_PRIN_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_DB_OPBAL,
SUM(ADVBBAL_PRIN_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_CR_OPBAL,
SUM(ADVBBAL_PRIN_AC_CR_OPBAL-ADVBBAL_PRIN_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_PRIN_AC_OPBAL,
SUM(ADVBBAL_INTRD_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_DB_OPBAL,
SUM(ADVBBAL_INTRD_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_CR_OPBAL,
SUM(ADVBBAL_INTRD_AC_CR_OPBAL-ADVBBAL_INTRD_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_INTRD_AC_OPBAL,
SUM(ADVBBAL_CHARGE_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_DB_OPBAL,
SUM(ADVBBAL_CHARGE_AC_CR_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_CR_OPBAL,
SUM(ADVBBAL_CHARGE_AC_CR_OPBAL-ADVBBAL_CHARGE_AC_DB_OPBAL) OVER(PARTITION BY LNACNT_INTERNAL_ACNUM ORDER BY LNACNT_INTERNAL_ACNUM,TRAN_YEAR,TRAN_MONTH) ADVBBAL_CHARGE_AC_OPBAL
FROM(
SELECT LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH, SUM(TRANADV_PRIN_AC_AMT_DR) ADVBBAL_PRIN_AC_DB_OPBAL, SUM(TRANADV_PRIN_AC_AMT_CR) ADVBBAL_PRIN_AC_CR_OPBAL, 
(SUM(TRANADV_PRIN_AC_AMT_CR) -SUM(TRANADV_PRIN_AC_AMT_DR)) TRANADV_PRIN_AC_AMT_OS,
SUM(TRANADV_INTRD_AC_AMT_DR) ADVBBAL_INTRD_AC_DB_OPBAL,SUM(TRANADV_INTRD_AC_AMT_CR) ADVBBAL_INTRD_AC_CR_OPBAL,
(SUM(TRANADV_INTRD_AC_AMT_CR)-SUM(TRANADV_INTRD_AC_AMT_DR)) TRANADV_INTRD_AC_AMT_OS,  
SUM(TRANADV_CHARGE_AC_AMT_DR) ADVBBAL_CHARGE_AC_DB_OPBAL, SUM(TRANADV_CHARGE_AC_AMT_CR) ADVBBAL_CHARGE_AC_CR_OPBAL,
(SUM(TRANADV_CHARGE_AC_AMT_CR) -SUM(TRANADV_CHARGE_AC_AMT_DR)) TRANADV_CHARGE_AC_AMT_OS
FROM(
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2014 T, LOANACNTS L,ACNTS A,  TRANADV2014 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2015 T, LOANACNTS L,ACNTS A,  TRANADV2015 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2016 T, LOANACNTS L,ACNTS A,  TRANADV2016 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2017 T, LOANACNTS L,ACNTS A,  TRANADV2017 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2018 T, LOANACNTS L,ACNTS A,  TRANADV2018 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2019 T, LOANACNTS L,ACNTS A,  TRANADV2019 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2020 T, LOANACNTS L,ACNTS A,  TRANADV2020 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2021 T, LOANACNTS L,ACNTS A,  TRANADV2021 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 
UNION ALL
SELECT  L.LNACNT_INTERNAL_ACNUM,TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'YYYY')) TRAN_YEAR, TO_NUMBER(TO_CHAR(ADD_MONTHS(TRAN_DATE_OF_TRAN,1),'MM')) TRAN_MONTH, 
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_PRIN_AC_AMT ELSE 0 END ) TRANADV_PRIN_AC_AMT_CR,  
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_INTRD_AC_AMT ELSE 0 END ) TRANADV_INTRD_AC_AMT_CR,
(CASE WHEN TRAN_DB_CR_FLG='D' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_DR,
(CASE WHEN TRAN_DB_CR_FLG='C' THEN  TRANADV_CHARGE_AC_AMT ELSE 0 END ) TRANADV_CHARGE_AC_AMT_CR
FROM TRAN2022 T, LOANACNTS L,ACNTS A,  TRANADV2022 TA
WHERE L.LNACNT_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND TA.TRANADV_ENTITY_NUM=T.TRAN_ENTITY_NUM
AND  TA.TRANADV_BRN_CODE=T.TRAN_BRN_CODE
AND  TA.TRANADV_DATE_OF_TRAN=T.TRAN_DATE_OF_TRAN
AND TA.TRANADV_BATCH_NUMBER=T.TRAN_BATCH_NUMBER
AND TA.TRANADV_BATCH_SL_NUM=T.TRAN_BATCH_SL_NUM
AND A.ACNTS_INTERNAL_ACNUM=T.TRAN_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=L.LNACNT_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
AND TRAN_AUTH_ON IS NOT NULL
--AND T.TRAN_INTERNAL_ACNUM=10104000001722
AND T.TRAN_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
AND TRAN_INTERNAL_ACNUM<>0 )
GROUP BY LNACNT_INTERNAL_ACNUM, TRAN_YEAR, TRAN_MONTH 
ORDER BY 1,2,3)) TRAN FULL OUTER JOIN (SELECT DISTINCT ADVBBAL_INTERNAL_ACNUM, ADVBBAL_YEAR, ADVBBAL_MONTH
FROM ADVBBAL AD, ACNTS A
WHERE AD.ADVBBAL_INTERNAL_ACNUM=A.ACNTS_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
--AND  ADVBBAL_INTERNAL_ACNUM =10104000001722
AND ADVBBAL_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE)
ORDER BY ADVBBAL_YEAR, ADVBBAL_MONTH) RECORDS
ON (TRAN.LNACNT_INTERNAL_ACNUM=RECORDS.ADVBBAL_INTERNAL_ACNUM AND TRAN.TRAN_YEAR=RECORDS.ADVBBAL_YEAR AND TRAN.TRAN_MONTH=RECORDS.ADVBBAL_MONTH))
SELECT TADV.ADVBBAL_INTERNAL_ACNUM, TADV.ADVBBAL_YEAR,TADV.ADVBBAL_MONTH, ADV.IACLINK_ACTUAL_ACNUM, ADV.IACLINK_BRN_CODE,  
(CASE WHEN (TADV.ADVBBAL_PRIN_AC_OPBAL<>ADV.ADVBBAL_PRIN_AC_OPBAL) THEN 'PO' 
         WHEN  (TADV.ADVBBAL_INTRD_AC_OPBAL<>ADV.ADVBBAL_INTRD_AC_OPBAL) THEN 'IO'
         WHEN (TADV.ADVBBAL_CHARGE_AC_OPBAL<>ADV.ADVBBAL_CHARGE_AC_OPBAL) THEN 'CO'
         WHEN (TADV.ADVBBAL_PRIN_AC_DB_OPBAL<>ADV.ADVBBAL_PRIN_AC_DB_OPBAL) THEN 'PD'
         WHEN (TADV.ADVBBAL_PRIN_AC_CR_OPBAL<>ADV.ADVBBAL_PRIN_AC_CR_OPBAL) THEN 'PC'
         WHEN (TADV.ADVBBAL_INTRD_AC_DB_OPBAL<>ADV.ADVBBAL_INTRD_AC_DB_OPBAL) THEN 'ID'
         WHEN (TADV.ADVBBAL_INTRD_AC_CR_OPBAL<>ADV.ADVBBAL_INTRD_AC_CR_OPBAL) THEN 'IC'
         WHEN (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL<>ADV.ADVBBAL_CHARGE_AC_DB_OPBAL) THEN 'CD'
         WHEN (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL<>ADV.ADVBBAL_CHARGE_AC_CR_OPBAL) THEN 'CC'
         ELSE 'NA' END ) DIFFERENCE, TADV.ADVBBAL_PRIN_AC_OPBAL,ADV.ADVBBAL_PRIN_AC_OPBAL VADVBBAL_PRIN_AC_OPBAL,
         TADV.ADVBBAL_INTRD_AC_OPBAL,ADV.ADVBBAL_INTRD_AC_OPBAL VADVBBAL_INTRD_AC_OPBAL, TADV.ADVBBAL_CHARGE_AC_OPBAL, 
         ADV.ADVBBAL_CHARGE_AC_OPBAL VADVBBAL_CHARGE_AC_OPBAL,TADV.ADVBBAL_PRIN_AC_DB_OPBAL,ADV.ADVBBAL_PRIN_AC_DB_OPBAL VADVBBAL_PRIN_AC_DB_OPBAL,  
         TADV.ADVBBAL_PRIN_AC_CR_OPBAL, ADV.ADVBBAL_PRIN_AC_CR_OPBAL VADVBBAL_PRIN_AC_CR_OPBAL, TADV.ADVBBAL_INTRD_AC_DB_OPBAL,
         ADV.ADVBBAL_INTRD_AC_DB_OPBAL VADVBBAL_INTRD_AC_DB_OPBAL, TADV.ADVBBAL_INTRD_AC_CR_OPBAL,  ADV.ADVBBAL_INTRD_AC_CR_OPBAL  VADVBBAL_INTRD_AC_CR_OPBAL,
         TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,ADV.ADVBBAL_CHARGE_AC_DB_OPBAL VADVBBAL_CHARGE_AC_DB_OPBAL,TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,
          ADV.ADVBBAL_CHARGE_AC_CR_OPBAL VADVBBAL_CHARGE_AC_CR_OPBAL
FROM(
SELECT TADV.ADVBBAL_INTERNAL_ACNUM, TADV.ADVBBAL_YEAR,TADV.ADVBBAL_MONTH, 
NVL(TADV.ADVBBAL_PRIN_AC_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_OPBAL, 
NVL(TADV.ADVBBAL_PRIN_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_PRIN_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_PRIN_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_PRIN_AC_CR_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_INTRD_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_INTRD_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_INTRD_AC_CR_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_DB_OPBAL, 
NVL(TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,(LAG (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL,1) OVER (PARTITION BY
TADV.ADVBBAL_INTERNAL_ACNUM ORDER BY TADV.ADVBBAL_INTERNAL_ACNUM,TADV.ADVBBAL_YEAR))) ADVBBAL_CHARGE_AC_CR_OPBAL
 FROM TRAN_LOAN_ADVBAL TADV) TADV, (SELECT ADVBBAL_INTERNAL_ACNUM, IA.IACLINK_ACTUAL_ACNUM, IA.IACLINK_BRN_CODE, ADVBBAL_YEAR, ADVBBAL_MONTH, ADVBBAL_PRIN_AC_OPBAL, 
 ADVBBAL_INTRD_AC_OPBAL, ADVBBAL_CHARGE_AC_OPBAL, ADVBBAL_PRIN_AC_DB_OPBAL, ADVBBAL_PRIN_AC_CR_OPBAL, ADVBBAL_INTRD_AC_DB_OPBAL, 
 ADVBBAL_INTRD_AC_CR_OPBAL, ADVBBAL_CHARGE_AC_DB_OPBAL, ADVBBAL_CHARGE_AC_CR_OPBAL
FROM ADVBBAL AD, ACNTS A, IACLINK IA
WHERE AD.ADVBBAL_INTERNAL_ACNUM=A.ACNTS_INTERNAL_ACNUM
AND A.ACNTS_INTERNAL_ACNUM=IA.IACLINK_INTERNAL_ACNUM
AND AD.ADVBBAL_INTERNAL_ACNUM=IA.IACLINK_INTERNAL_ACNUM
--AND A.ACNTS_CLOSURE_DATE IS  NULL
) ADV 
WHERE TADV.ADVBBAL_INTERNAL_ACNUM=ADV.ADVBBAL_INTERNAL_ACNUM
AND TADV.ADVBBAL_YEAR=ADV.ADVBBAL_YEAR
AND TADV.ADVBBAL_MONTH=ADV.ADVBBAL_MONTH
AND ((TADV.ADVBBAL_PRIN_AC_OPBAL<>ADV.ADVBBAL_PRIN_AC_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_OPBAL<>ADV.ADVBBAL_INTRD_AC_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_OPBAL<>ADV.ADVBBAL_CHARGE_AC_OPBAL)
         OR (TADV.ADVBBAL_PRIN_AC_DB_OPBAL<>ADV.ADVBBAL_PRIN_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_PRIN_AC_CR_OPBAL<>ADV.ADVBBAL_PRIN_AC_CR_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_DB_OPBAL<>ADV.ADVBBAL_INTRD_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_INTRD_AC_CR_OPBAL<>ADV.ADVBBAL_INTRD_AC_CR_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_DB_OPBAL<>ADV.ADVBBAL_CHARGE_AC_DB_OPBAL)
         OR (TADV.ADVBBAL_CHARGE_AC_CR_OPBAL<>ADV.ADVBBAL_CHARGE_AC_CR_OPBAL))
ORDER BY 1,2,3)
LOOP
UPDATE ACNTVDBBAL
SET ACNTVBBAL_AC_OPNG_DB_SUM=IND.ADVBBAL_PRIN_AC_DB_OPBAL+IND.ADVBBAL_INTRD_AC_DB_OPBAL+IND.ADVBBAL_CHARGE_AC_DB_OPBAL, 
        ACNTVBBAL_BC_OPNG_DB_SUM=IND.ADVBBAL_PRIN_AC_DB_OPBAL+IND.ADVBBAL_INTRD_AC_DB_OPBAL+IND.ADVBBAL_CHARGE_AC_DB_OPBAL, 
        ACNTVBBAL_AC_OPNG_CR_SUM=IND.ADVBBAL_PRIN_AC_CR_OPBAL+IND.ADVBBAL_INTRD_AC_CR_OPBAL+IND.ADVBBAL_CHARGE_AC_CR_OPBAL, 
        ACNTVBBAL_BC_OPNG_CR_SUM=IND.ADVBBAL_PRIN_AC_CR_OPBAL+IND.ADVBBAL_INTRD_AC_CR_OPBAL+IND.ADVBBAL_CHARGE_AC_CR_OPBAL
WHERE ACNTVBBAL_INTERNAL_ACNUM=IND.ADVBBAL_INTERNAL_ACNUM
AND ACNTVBBAL_YEAR=IND.ADVBBAL_YEAR
AND ACNTVBBAL_MONTH=IND.ADVBBAL_MONTH;

END LOOP;
END;


----------- Update LLACNTOS  ---------

BEGIN
   FOR IDX
      IN (SELECT AA.ACNTBAL_INTERNAL_ACNUM, AA.ACNTBAL_AC_BAL
            FROM ACNTBAL AA
           WHERE AA.ACNTBAL_INTERNAL_ACNUM IN
                    (SELECT A.ACNTS_INTERNAL_ACNUM
                       FROM ACNTS A
                      WHERE A.ACNTS_PROD_CODE IN
                               (SELECT P.PRODUCT_CODE
                                  FROM PRODUCTS P
                                 WHERE     P.PRODUCT_FOR_LOANS = 1
                                       ))
                 AND AA.ACNTBAL_INTERNAL_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE))
   LOOP
      UPDATE LLACNTOS C
         SET C.LLACNTOS_LIMIT_CURR_OS_AMT = IDX.ACNTBAL_AC_BAL
       WHERE C.LLACNTOS_CLIENT_ACNUM = IDX.ACNTBAL_INTERNAL_ACNUM;
   END LOOP;
END;




SELECT * FROM LLACNTOS WHERE LLACNTOS_CLIENT_ACNUM IN (SELECT IACLINK_INTERNAL_ACNUM FROM ACTUAL_ACCOUNT_UPDATE);